<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tudo Voice Uploader</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; text-align: center; padding: 20px; }
    #meter { width: 300px; height: 30px; background-color: #333; border-radius: 5px; overflow: hidden; margin: 20px auto; }
    #meter-fill { height: 100%; width: 0%; background-color: #4caf50; transition: width 0.1s; }
    input, select, button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #status { margin-top: 20px; font-size: 18px; }
    .uploading { animation: blink 1s infinite; }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
  </style>
</head>

<body>
  <h1>Tudo Voice Uploader</h1>

  <form id="uploadForm">
    <input type="email" id="emailInput" placeholder="Enter your email" required><br>
    
    <label for="timezone">Select Timezone:</label>
    <select id="timezone" required>
      <option value="America/Detroit">Eastern (US)</option>
      <option value="America/Chicago">Central (US)</option>
      <option value="America/Denver">Mountain (US)</option>
      <option value="America/Los_Angeles">Pacific (US)</option>
      <option value="UTC">UTC (Universal)</option>
    </select><br>

    <button type="button" id="recordButton">Record</button>
    <button type="button" id="stopButton" disabled>Stop</button><br><br>
  </form>

  <div id="meter">
    <div id="meter-fill"></div>
  </div>

  <p id="status"></p>

<script>
window.onload = function() {
  let mediaRecorder;
  let audioChunks;
  let audioContext;
  let analyser;
  let microphone;
  let meterFill;
  let animationId;

  meterFill = document.getElementById('meter-fill');
  const recordButton = document.getElementById('recordButton');
  const stopButton = document.getElementById('stopButton');
  const status = document.getElementById('status');
  const emailInput = document.getElementById('emailInput');
  const timezoneSelect = document.getElementById('timezone');

  // Restore saved email and timezone
  const savedEmail = localStorage.getItem('savedEmail');
  if (savedEmail) {
    emailInput.value = savedEmail;
  }

  const savedTimezone = localStorage.getItem('savedTimezone');
  if (savedTimezone) {
    timezoneSelect.value = savedTimezone;
  }

  // Save when changed
  emailInput.addEventListener('input', () => {
    localStorage.setItem('savedEmail', emailInput.value);
  });
  timezoneSelect.addEventListener('change', () => {
    localStorage.setItem('savedTimezone', timezoneSelect.value);
  });

  recordButton.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const timezone = timezoneSelect.value;

    if (!validateEmail(email)) {
      status.textContent = "❌ Please enter a valid email.";
      return;
    }

    if (!timezone) {
      status.textContent = "❌ Please select a timezone.";
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    microphone = audioContext.createMediaStreamSource(stream);
    microphone.connect(analyser);
    analyser.fftSize = 256;

    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
    audioChunks = [];

    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };

    mediaRecorder.onstop = async () => {
      stopButton.disabled = true;
      recordButton.disabled = false;
      cancelAnimationFrame(animationId);
      audioContext.close();
      status.textContent = "Uploading...";
      status.classList.add('uploading');

      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const safeEmail = email.replace(/[^a-zA-Z0-9@.]/g, "_");
      const safeTimezone = timezone.replace(/[^a-zA-Z0-9/]/g, "_");
      const timestamp = Date.now();
      const filename = `${safeEmail}__${safeTimezone}__${timestamp}.webm`;

      const formData = new FormData();
      formData.append('file', audioBlob, filename);

      const uploadResponse = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      if (uploadResponse.ok) {
        status.textContent = '✅ Upload complete!';
        status.classList.remove('uploading');
        console.log('✅ File uploaded successfully!');
      } else {
        status.textContent = '❌ Upload failed.';
        status.classList.remove('uploading');
        console.error('❌ Upload failed with status:', uploadResponse.status);
      }
    };

    mediaRecorder.start();
    recordButton.disabled = true;
    stopButton.disabled = false;
    status.textContent = "Recording...";

    animateMeter();

    setTimeout(() => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    }, 30000); // Auto stop after 30s
  });

  stopButton.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
  });

  function animateMeter() {
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    const draw = () => {
      analyser.getByteFrequencyData(dataArray);
      let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
      let percent = Math.min(100, (volume / 255) * 100);
      meterFill.style.width = percent + "%";
      animationId = requestAnimationFrame(draw);
    };
    draw();
  }

  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }
}
</script>
</body>
</html>
